<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instagram Calendar JSON to Excel Converter</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }
        
        .drop-zone {
            transition: all 0.3s ease;
        }
        
        .drop-zone.drag-over {
            background-color: #e0f2fe !important;
            border-color: #0ea5e9 !important;
            transform: scale(1.02);
        }
        
        .table-container {
            max-height: 500px;
            overflow: auto;
        }
        
        .table-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        .table-container::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        
        .table-container::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 4px;
        }
        
        .table-container::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        
        .fade-in {
            animation: fadeIn 0.4s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        @media (max-width: 768px) {
            .table-container table {
                font-size: 12px;
            }
            
            .table-container th,
            .table-container td {
                padding: 8px 6px;
            }
        }
    </style>
</head>
<body class="bg-white min-h-screen">
    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Header -->
        <header class="text-center mb-10">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-purple-500 via-pink-500 to-orange-400 rounded-2xl mb-4 shadow-lg">
                <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                </svg>
            </div>
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">Instagram Calendar JSON to Excel</h1>
            <p class="text-gray-500 text-lg">Convert your Instagram Calendar Planner exports into clean Excel files</p>
        </header>

        <!-- Upload Section -->
        <section id="uploadSection" class="mb-10 fade-in">
            <div id="dropZone" class="drop-zone border-2 border-dashed border-gray-300 rounded-2xl p-12 text-center cursor-pointer hover:border-purple-400 hover:bg-purple-50/30 bg-gray-50">
                <div class="mb-4">
                    <svg class="w-16 h-16 mx-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                    </svg>
                </div>
                <h3 class="text-xl font-semibold text-gray-700 mb-2">Drop your JSON file here</h3>
                <p class="text-gray-500 mb-4">or click to browse</p>
                <input type="file" id="fileInput" accept=".json" class="hidden">
                <button onclick="document.getElementById('fileInput').click()" class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-medium rounded-xl hover:from-purple-600 hover:to-pink-600 transition-all shadow-md hover:shadow-lg">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                    </svg>
                    Select JSON File
                </button>
            </div>
        </section>

        <!-- Status Messages -->
        <div id="statusMessage" class="hidden mb-6 p-4 rounded-xl text-center font-medium fade-in"></div>

        <!-- Progress Section -->
        <div id="progressSection" class="hidden mb-8 fade-in">
            <div class="bg-gray-100 rounded-xl p-6">
                <div class="flex items-center justify-center space-x-3">
                    <svg class="w-6 h-6 text-purple-500 animate-spin" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="text-gray-700" id="progressText">Processing your file...</span>
                </div>
            </div>
        </div>

        <!-- Filters Section -->
        <section id="filtersSection" class="hidden mb-6 fade-in">
            <div class="bg-gray-50 rounded-xl p-4 md:p-6">
                <div class="flex flex-col md:flex-row md:items-center gap-4">
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Page</label>
                        <select id="pageFilter" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 bg-white">
                            <option value="all">All Pages</option>
                        </select>
                    </div>
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Month</label>
                        <select id="monthFilter" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 bg-white">
                            <option value="all">All Months</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button onclick="resetFilters()" class="px-4 py-2.5 text-gray-600 hover:text-gray-800 font-medium">
                            Reset Filters
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Stats Summary -->
        <section id="statsSection" class="hidden mb-8 fade-in">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-5 text-white shadow-md">
                    <p class="text-purple-100 text-sm font-medium">Total Posts</p>
                    <p class="text-3xl font-bold mt-1" id="statTotal">0</p>
                </div>
                <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-5 text-white shadow-md">
                    <p class="text-blue-100 text-sm font-medium">Ready</p>
                    <p class="text-3xl font-bold mt-1" id="statReady">0</p>
                </div>
                <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-5 text-white shadow-md">
                    <p class="text-green-100 text-sm font-medium">Posted</p>
                    <p class="text-3xl font-bold mt-1" id="statPosted">0</p>
                </div>
                <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl p-5 text-white shadow-md">
                    <p class="text-orange-100 text-sm font-medium">Pages</p>
                    <p class="text-3xl font-bold mt-1" id="statPages">0</p>
                </div>
            </div>
        </section>

        <!-- Preview Table -->
        <section id="previewSection" class="hidden mb-8 fade-in">
            <div class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <h2 class="text-xl font-semibold text-gray-800">Content Preview</h2>
                    <p class="text-gray-500 text-sm"><span id="filteredCount">0</span> entries shown</p>
                </div>
                <div class="table-container">
                    <table class="w-full">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Page</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Date</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Type</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Status</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider min-w-[200px]">Caption</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Images</th>
                            </tr>
                        </thead>
                        <tbody id="previewTableBody" class="divide-y divide-gray-100">
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Export Button -->
        <section id="exportSection" class="hidden text-center mb-10 fade-in">
            <button onclick="exportToExcel()" class="inline-flex items-center px-8 py-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-semibold rounded-xl hover:from-green-600 hover:to-emerald-700 transition-all shadow-lg hover:shadow-xl text-lg">
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                Download Excel File
            </button>
            <p class="text-gray-500 text-sm mt-3">File will include: Overview, Content Calendar, and Media Summary sheets</p>
        </section>

        <!-- New File Button -->
        <section id="newFileSection" class="hidden text-center fade-in">
            <button onclick="resetApp()" class="inline-flex items-center px-6 py-3 border-2 border-gray-300 text-gray-700 font-medium rounded-xl hover:border-gray-400 hover:bg-gray-50 transition-all">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                Process Another File
            </button>
        </section>

        <!-- Footer -->
        <footer class="text-center text-gray-400 text-sm mt-16 pb-8">
            <p>All processing happens locally in your browser. No data is uploaded anywhere.</p>
        </footer>
    </div>

    <script>
        // Global state
        let parsedData = [];
        let filteredData = [];
        let uniquePages = [];
        let uniqueMonths = [];

        // DOM Elements
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const statusMessage = document.getElementById('statusMessage');
        const progressSection = document.getElementById('progressSection');
        const progressText = document.getElementById('progressText');
        const filtersSection = document.getElementById('filtersSection');
        const statsSection = document.getElementById('statsSection');
        const previewSection = document.getElementById('previewSection');
        const exportSection = document.getElementById('exportSection');
        const newFileSection = document.getElementById('newFileSection');
        const previewTableBody = document.getElementById('previewTableBody');
        const pageFilter = document.getElementById('pageFilter');
        const monthFilter = document.getElementById('monthFilter');

        // Event Listeners
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        pageFilter.addEventListener('change', applyFilters);
        monthFilter.addEventListener('change', applyFilters);

        // Show status message
        function showStatus(message, type = 'info') {
            statusMessage.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'bg-blue-100', 'text-blue-800');
            
            if (type === 'success') {
                statusMessage.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'error') {
                statusMessage.classList.add('bg-red-100', 'text-red-800');
            } else {
                statusMessage.classList.add('bg-blue-100', 'text-blue-800');
            }
            
            statusMessage.textContent = message;
        }

        // Hide status message
        function hideStatus() {
            statusMessage.classList.add('hidden');
        }

        // Show progress
        function showProgress(message) {
            progressSection.classList.remove('hidden');
            progressText.textContent = message;
        }

        // Hide progress
        function hideProgress() {
            progressSection.classList.add('hidden');
        }

        // Handle file upload
        function handleFile(file) {
            if (!file.name.endsWith('.json')) {
                showStatus('Please upload a valid JSON file.', 'error');
                return;
            }

            hideStatus();
            showProgress('Reading file...');

            const reader = new FileReader();
            
            reader.onload = (e) => {
                try {
                    showProgress('Parsing JSON data...');
                    const jsonData = JSON.parse(e.target.result);
                    processJSON(jsonData);
                } catch (error) {
                    hideProgress();
                    showStatus('Invalid JSON file. Please check the file format.', 'error');
                    console.error('JSON Parse Error:', error);
                }
            };

            reader.onerror = () => {
                hideProgress();
                showStatus('Error reading file. Please try again.', 'error');
            };

            reader.readAsText(file);
        }

        // Process JSON data
        function processJSON(jsonData) {
            showProgress('Extracting calendar data...');
            
            parsedData = [];
            
            try {
                // Handle different JSON structures
                let entries = [];
                
                if (Array.isArray(jsonData)) {
                    entries = jsonData;
                } else if (jsonData.posts) {
                    entries = jsonData.posts;
                } else if (jsonData.data) {
                    entries = Array.isArray(jsonData.data) ? jsonData.data : [jsonData.data];
                } else if (jsonData.calendar) {
                    entries = Array.isArray(jsonData.calendar) ? jsonData.calendar : [jsonData.calendar];
                } else if (jsonData.entries) {
                    entries = jsonData.entries;
                } else if (jsonData.items) {
                    entries = jsonData.items;
                } else {
                    // Try to extract from nested structure or treat as single entry
                    entries = [jsonData];
                }

                // Process each entry
                entries.forEach(entry => {
                    const processed = extractEntryData(entry);
                    if (processed) {
                        if (Array.isArray(processed)) {
                            parsedData.push(...processed);
                        } else {
                            parsedData.push(processed);
                        }
                    }
                });

                // Also check for nested page structures
                if (parsedData.length === 0) {
                    Object.keys(jsonData).forEach(key => {
                        if (typeof jsonData[key] === 'object' && jsonData[key] !== null) {
                            const nestedEntries = jsonData[key];
                            if (Array.isArray(nestedEntries)) {
                                nestedEntries.forEach(entry => {
                                    const processed = extractEntryData(entry, key);
                                    if (processed) {
                                        parsedData.push(processed);
                                    }
                                });
                            } else if (nestedEntries.posts || nestedEntries.calendar || nestedEntries.entries) {
                                const items = nestedEntries.posts || nestedEntries.calendar || nestedEntries.entries;
                                items.forEach(entry => {
                                    const processed = extractEntryData(entry, key);
                                    if (processed) {
                                        parsedData.push(processed);
                                    }
                                });
                            }
                        }
                    });
                }

                if (parsedData.length === 0) {
                    hideProgress();
                    showStatus('No valid calendar entries found in the JSON file. Please check the file structure.', 'error');
                    return;
                }

                // Sort by date
                parsedData.sort((a, b) => new Date(a.date) - new Date(b.date));

                // Extract unique pages and months
                uniquePages = [...new Set(parsedData.map(d => d.page))].filter(Boolean).sort();
                uniqueMonths = [...new Set(parsedData.map(d => {
                    if (d.date) {
                        const date = new Date(d.date);
                        if (!isNaN(date)) {
                            return date.toLocaleString('default', { month: 'long', year: 'numeric' });
                        }
                    }
                    return null;
                }))].filter(Boolean);

                showProgress('Building preview...');
                
                setTimeout(() => {
                    populateFilters();
                    filteredData = [...parsedData];
                    updateStats();
                    renderTable();
                    
                    hideProgress();
                    showStatus(`Successfully processed ${parsedData.length} calendar entries!`, 'success');
                    
                    filtersSection.classList.remove('hidden');
                    statsSection.classList.remove('hidden');
                    previewSection.classList.remove('hidden');
                    exportSection.classList.remove('hidden');
                    newFileSection.classList.remove('hidden');
                }, 300);

            } catch (error) {
                hideProgress();
                showStatus('Error processing data: ' + error.message, 'error');
                console.error('Processing Error:', error);
            }
        }

        // Extract data from entry
        function extractEntryData(entry, defaultPage = 'Unknown Page') {
            if (!entry || typeof entry !== 'object') return null;
            
            // Skip if it looks like just image data
            if (entry.base64 || entry.blob || (entry.type && entry.type.startsWith('image/'))) {
                return null;
            }

            // Count images
            let imageCount = 0;
            if (entry.images && Array.isArray(entry.images)) {
                imageCount = entry.images.length;
            } else if (entry.media && Array.isArray(entry.media)) {
                imageCount = entry.media.filter(m => !m.base64 && !m.blob).length || entry.media.length;
            } else if (entry.imageCount) {
                imageCount = entry.imageCount;
            } else if (entry.image) {
                imageCount = 1;
            } else if (entry.mediaCount) {
                imageCount = entry.mediaCount;
            }

            // Extract fields with multiple fallbacks
            const page = entry.page || entry.pageName || entry.account || entry.accountName || entry.profile || defaultPage;
            const date = entry.date || entry.scheduledDate || entry.postDate || entry.publishDate || entry.scheduled_date || entry.created || '';
            const postType = entry.postType || entry.type || entry.contentType || entry.post_type || entry.format || 'Post';
            const status = entry.status || entry.state || entry.postStatus || 'Draft';
            const caption = entry.caption || entry.text || entry.content || entry.description || entry.body || '';
            const hashtags = entry.hashtags || entry.tags || entry.hashTags || '';
            const notes = entry.notes || entry.note || entry.comments || entry.memo || '';

            // Skip entries that don't have meaningful data
            if (!date && !caption && !notes) {
                return null;
            }

            return {
                page: String(page).trim(),
                date: formatDate(date),
                rawDate: date,
                postType: String(postType).trim(),
                status: String(status).trim(),
                caption: cleanCaption(caption),
                hashtags: formatHashtags(hashtags),
                notes: String(notes).trim(),
                imageCount: imageCount
            };
        }

        // Format date
        function formatDate(dateStr) {
            if (!dateStr) return '';
            
            try {
                const date = new Date(dateStr);
                if (isNaN(date)) return String(dateStr);
                
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            } catch {
                return String(dateStr);
            }
        }

        // Clean caption (remove image blobs)
        function cleanCaption(caption) {
            if (!caption) return '';
            if (typeof caption !== 'string') {
                if (Array.isArray(caption)) {
                    caption = caption.join(' ');
                } else {
                    caption = String(caption);
                }
            }
            // Remove base64 data and URLs that look like blob references
            return caption
                .replace(/data:image\/[^;]+;base64,[^\s"']*/g, '')
                .replace(/blob:[^\s"']*/g, '')
                .trim();
        }

        // Format hashtags
        function formatHashtags(tags) {
            if (!tags) return '';
            
            if (Array.isArray(tags)) {
                return tags.map(t => {
                    t = String(t).trim();
                    return t.startsWith('#') ? t : '#' + t;
                }).join(' ');
            }
            
            return String(tags).trim();
        }

        // Populate filter dropdowns
        function populateFilters() {
            pageFilter.innerHTML = '<option value="all">All Pages</option>';
            uniquePages.forEach(page => {
                const option = document.createElement('option');
                option.value = page;
                option.textContent = page;
                pageFilter.appendChild(option);
            });

            monthFilter.innerHTML = '<option value="all">All Months</option>';
            uniqueMonths.forEach(month => {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = month;
                monthFilter.appendChild(option);
            });
        }

        // Apply filters
        function applyFilters() {
            const selectedPage = pageFilter.value;
            const selectedMonth = monthFilter.value;

            filteredData = parsedData.filter(entry => {
                let matchesPage = selectedPage === 'all' || entry.page === selectedPage;
                let matchesMonth = selectedMonth === 'all';
                
                if (!matchesMonth && entry.date) {
                    const date = new Date(entry.rawDate);
                    if (!isNaN(date)) {
                        const entryMonth = date.toLocaleString('default', { month: 'long', year: 'numeric' });
                        matchesMonth = entryMonth === selectedMonth;
                    }
                }
                
                return matchesPage && matchesMonth;
            });

            updateStats();
            renderTable();
        }

        // Reset filters
        function resetFilters() {
            pageFilter.value = 'all';
            monthFilter.value = 'all';
            filteredData = [...parsedData];
            updateStats();
            renderTable();
        }

        // Update statistics
        function updateStats() {
            const total = filteredData.length;
            const ready = filteredData.filter(d => 
                d.status.toLowerCase().includes('ready') || 
                d.status.toLowerCase().includes('scheduled') ||
                d.status.toLowerCase().includes('approved')
            ).length;
            const posted = filteredData.filter(d => 
                d.status.toLowerCase().includes('posted') || 
                d.status.toLowerCase().includes('published') ||
                d.status.toLowerCase().includes('complete')
            ).length;
            const pages = new Set(filteredData.map(d => d.page)).size;

            document.getElementById('statTotal').textContent = total;
            document.getElementById('statReady').textContent = ready;
            document.getElementById('statPosted').textContent = posted;
            document.getElementById('statPages').textContent = pages;
            document.getElementById('filteredCount').textContent = total;
        }

        // Render preview table
        function renderTable() {
            previewTableBody.innerHTML = '';

            if (filteredData.length === 0) {
                previewTableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                            No entries match the selected filters.
                        </td>
                    </tr>
                `;
                return;
            }

            filteredData.forEach(entry => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors';
                
                const statusColor = getStatusColor(entry.status);
                const truncatedCaption = entry.caption.length > 100 
                    ? entry.caption.substring(0, 100) + '...' 
                    : entry.caption;

                row.innerHTML = `
                    <td class="px-4 py-3 text-sm text-gray-900 font-medium">${escapeHtml(entry.page)}</td>
                    <td class="px-4 py-3 text-sm text-gray-600 whitespace-nowrap">${escapeHtml(entry.date)}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${escapeHtml(entry.postType)}</td>
                    <td class="px-4 py-3">
                        <span class="inline-flex px-2.5 py-1 text-xs font-medium rounded-full ${statusColor}">
                            ${escapeHtml(entry.status)}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-600 max-w-xs">${escapeHtml(truncatedCaption)}</td>
                    <td class="px-4 py-3 text-sm text-gray-600 text-center">${entry.imageCount}</td>
                `;
                
                previewTableBody.appendChild(row);
            });
        }

        // Get status color
        function getStatusColor(status) {
            const s = status.toLowerCase();
            if (s.includes('posted') || s.includes('published') || s.includes('complete')) {
                return 'bg-green-100 text-green-800';
            } else if (s.includes('ready') || s.includes('scheduled') || s.includes('approved')) {
                return 'bg-blue-100 text-blue-800';
            } else if (s.includes('draft') || s.includes('pending')) {
                return 'bg-yellow-100 text-yellow-800';
            } else if (s.includes('failed') || s.includes('error') || s.includes('rejected')) {
                return 'bg-red-100 text-red-800';
            }
            return 'bg-gray-100 text-gray-800';
        }

        // Escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Export to Excel
        function exportToExcel() {
            showProgress('Generating Excel file...');

            setTimeout(() => {
                try {
                    const wb = XLSX.utils.book_new();

                    // Sheet 1: Overview
                    const overviewData = [];
                    const pageStats = {};
                    
                    parsedData.forEach(entry => {
                        if (!pageStats[entry.page]) {
                            pageStats[entry.page] = { total: 0, ready: 0, posted: 0 };
                        }
                        pageStats[entry.page].total++;
                        
                        const s = entry.status.toLowerCase();
                        if (s.includes('posted') || s.includes('published') || s.includes('complete')) {
                            pageStats[entry.page].posted++;
                        } else if (s.includes('ready') || s.includes('scheduled') || s.includes('approved')) {
                            pageStats[entry.page].ready++;
                        }
                    });

                    overviewData.push(['Page Name', 'Total Posts', 'Ready Posts', 'Posted Posts']);
                    Object.keys(pageStats).forEach(page => {
                        overviewData.push([
                            page,
                            pageStats[page].total,
                            pageStats[page].ready,
                            pageStats[page].posted
                        ]);
                    });

                    const wsOverview = XLSX.utils.aoa_to_sheet(overviewData);
                    wsOverview['!cols'] = [{ wch: 25 }, { wch: 12 }, { wch: 12 }, { wch: 12 }];
                    XLSX.utils.book_append_sheet(wb, wsOverview, 'Overview');

                    // Sheet 2: Content Calendar
                    const calendarData = [['Page', 'Date', 'Post Type', 'Status', 'Caption', 'Hashtags', 'Notes']];
                    parsedData.forEach(entry => {
                        calendarData.push([
                            entry.page,
                            entry.date,
                            entry.postType,
                            entry.status,
                            entry.caption,
                            entry.hashtags,
                            entry.notes
                        ]);
                    });

                    const wsCalendar = XLSX.utils.aoa_to_sheet(calendarData);
                    wsCalendar['!cols'] = [
                        { wch: 20 }, { wch: 15 }, { wch: 12 }, { wch: 12 }, 
                        { wch: 50 }, { wch: 30 }, { wch: 30 }
                    ];
                    XLSX.utils.book_append_sheet(wb, wsCalendar, 'Content Calendar');

                    // Sheet 3: Media Summary
                    const mediaData = [['Page', 'Date', 'Image Count']];
                    parsedData.forEach(entry => {
                        mediaData.push([
                            entry.page,
                            entry.date,
                            entry.imageCount
                        ]);
                    });

                    const wsMedia = XLSX.utils.aoa_to_sheet(mediaData);
                    wsMedia['!cols'] = [{ wch: 20 }, { wch: 15 }, { wch: 12 }];
                    XLSX.utils.book_append_sheet(wb, wsMedia, 'Media Summary');

                    // Generate filename
                    const now = new Date();
                    const year = now.getFullYear();
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    const filename = `instagram-calendar-client-${year}-${month}.xlsx`;

                    // Download
                    XLSX.writeFile(wb, filename);

                    hideProgress();
                    showStatus(`Excel file "${filename}" downloaded successfully!`, 'success');

                } catch (error) {
                    hideProgress();
                    showStatus('Error generating Excel file: ' + error.message, 'error');
                    console.error('Export Error:', error);
                }
            }, 500);
        }

        // Reset application
        function resetApp() {
            parsedData = [];
            filteredData = [];
            uniquePages = [];
            uniqueMonths = [];
            
            fileInput.value = '';
            hideStatus();
            hideProgress();
            
            filtersSection.classList.add('hidden');
            statsSection.classList.add('hidden');
            previewSection.classList.add('hidden');
            exportSection.classList.add('hidden');
            newFileSection.classList.add('hidden');
            
            previewTableBody.innerHTML = '';
            pageFilter.innerHTML = '<option value="all">All Pages</option>';
            monthFilter.innerHTML = '<option value="all">All Months</option>';
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
</body>
</html>
